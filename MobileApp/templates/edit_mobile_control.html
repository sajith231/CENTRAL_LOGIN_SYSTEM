{% extends 'base.html' %}
{% block content %}

<div class="card" style="padding:20px;">
    <h2 style="color:whitesmoke;">Edit Mobile Control</h2>

    <form method="POST">
        {% csrf_token %}

        <!-- Project -->
        <div class="mb-3">
            <label>Project</label>
            <select name="project" class="form-control" required
                    style="background:#0f1b31; color:white; border:1px solid #334155;">

                {% for project in projects %}
                <option value="{{ project.id }}"
                        {% if project.id == control.project.id %}selected{% endif %}
                        style="background:#0f1b31; color:white;">
                    {{ project.project_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Shop -->
        <div class="mb-3">
            <label>Shop</label>
            <select id="shopSelect" name="shop" class="form-control" required
                    style="background:#0f1b31; color:white; border:1px solid #334155;">

                {% for shop in shops %}
                <option value="{{ shop.id }}"
                        data-client="{{ shop.client_id }}"
                        {% if shop.id == control.shop_id %}selected{% endif %}
                        style="background:#0f1b31; color:white;">
                    {{ shop.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Client ID -->
        <div class="mb-3">
            <label>Client ID</label>
            <input type="text" id="clientIdInput" class="form-control"
                   value="{{ control.client_id }}" readonly
                   style="background:#0f1b31; color:white; border:1px solid #334155;">
        </div>

        <!-- Login Limit -->
        <div class="mb-3">
            <label>Login Limit</label>
            <input type="number" name="login_limit" class="form-control"
                   value="{{ control.login_limit }}" required
                   style="background:#0f1b31; color:white; border:1px solid #334155;">
        </div>
       <div class="mb-3">
    <label>Package</label>
    <select id="packageSelect" name="package" class="form-control" required
            style="background:#0f1b31; color:white; border:1px solid #334155;">
        <option value="">Select Package</option>
    </select>
</div>

        <button type="submit" class="btn btn-primary">Update</button>
    </form>
</div>

<script>
document.getElementById("shopSelect").addEventListener("change", function() {
    const selectedOption = this.options[this.selectedIndex];
    const clientId = selectedOption.getAttribute("data-client") || "";
    document.getElementById("clientIdInput").value = clientId;
});
</script>

<script>
let selectedPkg = "{{ control.package.id }}";
let selectedProject = "{{ control.project.id }}";

function loadPackages(projectID, selectedPkgID = null) {
    fetch(`/module-package/get-packages/${projectID}/`)
        .then(res => res.json())
        .then(data => {
            let pkgSelect = document.getElementById("packageSelect");
            pkgSelect.innerHTML = '<option value="">Select Package</option>';

            data.forEach(pkg => {
                pkgSelect.innerHTML += `
                    <option value="${pkg.id}"
                        ${selectedPkgID == pkg.id ? "selected" : ""}
                        style="background:#0f1b31; color:white;">
                        ${pkg.package_name}
                    </option>`;
            });
        });
}

document.querySelector("select[name='project']").addEventListener("change", function () {
    loadPackages(this.value);
});

// Load packages on page load for the existing project
loadPackages(selectedProject, selectedPkg);
</script>

{% endblock %}
