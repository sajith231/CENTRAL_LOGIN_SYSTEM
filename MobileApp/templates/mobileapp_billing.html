{% extends "base.html" %}
{% block content %}

<style>
    .billing-status-btn {
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .billing-status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        filter: brightness(1.1);
    }

    .history-row {
        transition: background 0.2s ease;
    }

    .history-row:hover,
    .history-row:hover td {
        background: #1e293b !important;
    }

    .table,
    .table> :not(caption)>*>* {
        background: transparent !important;
    }

    .form-control {
        transition: all 0.2s ease;
    }

    .form-control:focus {
        background: #1e293b !important;
        color: white !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15) !important;
        outline: none;
    }

    .submit-btn {
        transition: all 0.2s ease;
    }

    .submit-btn:hover {
        background: #2563eb !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .stat-card {
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .badge-pill {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .compact-stat-card {
        background: #0f172a;
        border: 1px solid #1e293b;
        border-radius: 10px;
        padding: 16px;
        transition: all 0.2s ease;
    }

    .compact-stat-card:hover {
        transform: translateY(-2px);
        border-color: #334155;
    }

    .form-section {
        background: #0f172a;
        border: 1px solid #1e293b;
        border-radius: 10px;
        padding: 24px;
    }

    .operation-tab {
        cursor: pointer;
        padding: 10px 20px;
        border-radius: 8px;
        background: #1e293b;
        color: #94a3b8;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .operation-tab:hover {
        background: #334155;
        color: #e2e8f0;
    }

    .operation-tab.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .input-group-icon {
        position: relative;
        width: 1000px;
    }

    .input-group-icon i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        z-index: 10;
    }

    .input-group-icon input,
    .input-group-icon select,
    .input-group-icon textarea {
        padding-left: 42px !important;
    }
</style>

<div class="container-fluid px-4 py-4">

    <!-- BACK BUTTON -->
    <div class="mb-3">
        <a href="{% url 'MobileApp:mobile_control' %}" class="btn btn-outline-secondary btn-sm"
            style="border-radius:20px; color:#94a3b8; border-color:#334155;">
            <i class="fas fa-arrow-left me-1"></i> Back to Control
        </a>
    </div>

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-1" style="color:white; font-weight:600; font-size:1.75rem;">Billing Management</h2>
            <p class="mb-0" style="color:#94a3b8; font-size:0.9rem;">
                <i class="fas fa-user-circle me-1"></i>{{ control.customer_name }}
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <span class="badge badge-pill" style="background:#1e293b; color:#94a3b8;">
                <i class="fas fa-layer-group me-1"></i>{{ control.project.project_name }}
            </span>
            <span class="badge badge-pill" style="background:#1e293b; color:#94a3b8;">
                <i class="fas fa-box-open me-1"></i>{{ control.package.package_name|default:"No Package" }}
            </span>
            <span class="badge badge-pill" style="background:#1e293b; color:#94a3b8;">
                <i class="fas fa-id-card me-1"></i>ID: {{ control.client_id }}
            </span>
        </div>
    </div>

    <!-- COMPACT OVERVIEW CARDS -->
    <div class="row g-2 mb-3">
        <div class="col-md-4">
            <div class="compact-stat-card" style="padding:10px 12px;">
                <div class="d-flex align-items-center">
                    <div class="p-1 rounded me-2" style="background:#1e293b;">
                        <i class="fas fa-key" style="color:#3b82f6; font-size:0.8rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-0"
                            style="color:#64748b; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.3px; font-weight:600;">
                            License Key
                        </p>
                        <h6
                            style="color:white; font-family:monospace; font-size:0.75rem; margin:0; word-break:break-all;">
                            {% if control.license_key %}{{ control.license_key }}{% else %}No Key{% endif %}
                        </h6>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="compact-stat-card" style="padding:10px 12px;">
                <div class="d-flex align-items-center">
                    <div class="p-1 rounded me-2" style="background:#1e293b;">
                        <i class="fas fa-users" style="color:#8b5cf6; font-size:0.8rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-0"
                            style="color:#64748b; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.3px; font-weight:600;">
                            Current Users
                        </p>
                        <h6 style="color:#3b82f6; font-size:1.2rem; font-weight:700; margin:0;">{{ control.login_limit
                            }}</h6>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="compact-stat-card" style="padding:10px 12px;">
                <div class="d-flex align-items-center">
                    <div class="p-1 rounded me-2" style="background:#1e293b;">
                        <i class="fas fa-calendar-alt" style="color:#10b981; font-size:0.8rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-0"
                            style="color:#64748b; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.3px; font-weight:600;">
                            Expiry Date
                        </p>
                        <h6 style="color:white; font-size:0.85rem; font-weight:600; margin:0;">
                            {{ expiry_date|date:"d M Y"|default:"Unlimited" }}
                        </h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UPDATE FORM SECTION -->
    <div class="card mb-4" style="background:#0f172a; border:1px solid #1e293b; border-radius:10px;">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
                <div class="p-2 rounded me-2" style="background:#1e293b;">
                    <i class="fas fa-edit" style="color:#3b82f6; font-size:1rem;"></i>
                </div>
                <h5 class="mb-0" style="color:white; font-weight:600; font-size:1.1rem;">Update Billing</h5>
            </div>

            {% if has_unbilled_history %}
            <div class="alert mb-3"
                style="background:rgba(220, 38, 38, 0.15); border:1px solid #dc2626; color:#fca5a5; border-radius:8px; padding:12px;">
                <div class="d-flex align-items-start">
                    <i class="fas fa-exclamation-triangle mt-1 me-2" style="font-size:1rem;"></i>
                    <div>
                        <h6 style="color:#fecaca; font-weight:600; margin-bottom:4px; font-size:0.9rem;">Action Required
                        </h6>
                        <p class="mb-0" style="font-size:0.85rem;">
                            Outstanding <strong>Unbilled</strong> items exist. Mark them as "Billed" before proceeding.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <form method="POST">
                {% csrf_token %}

                <fieldset {% if has_unbilled_history %}disabled{% endif %}>
                    <!-- OPERATION TYPE TABS -->
                    <div class="d-flex gap-2 mb-3">
                        <div class="operation-tab active" id="tab_validity" onclick="toggleOperation('validity')">
                            <i class="fas fa-calendar-alt me-1"></i>Update Validity
                        </div>
                        <div class="operation-tab" id="tab_users" onclick="toggleOperation('users')">
                            <i class="fas fa-users me-1"></i>Update Users
                        </div>
                    </div>

                    <input type="hidden" name="operation_type" id="operation_type" value="validity">

                    <div class="row g-4">
                        <!-- VALIDITY SECTION -->
                        <div class="col-md-6" id="section_validity">
                            <label class="form-label mb-2" style="color:#94a3b8; font-size:0.85rem; font-weight:500;">
                                Select Package Extension
                            </label>
                            <div class="input-group-icon mb-3">
                                <i class="fas fa-box-open"></i>
                                <select name="package" id="packageSelect" class="form-control form-select"
                                    style="background:#1e293b; color:white; border:1px solid #334155; padding:10px 16px; border-radius:8px; font-size:0.9rem; cursor:pointer;"
                                    onchange="handlePackageChange(this)">
                                    <option value="" selected disabled>-- Select Package --</option>
                                    {% for p in packages %}
                                    <option value="{{ p.id }}" data-days="{{ p.days_limit }}">
                                        {{ p.package_name }} (+{{ p.days_limit }} days)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <small id="helperText" style="color:#64748b; font-size:0.75rem; display:block;">
                                <i class="fas fa-info-circle me-1"></i>Select a package to extend validity period
                            </small>
                        </div>

                        <!-- USER LIMIT SECTION -->
                        <div class="col-md-6" id="section_users" style="display:none;">
                            <label class="form-label mb-2" style="color:#94a3b8; font-size:0.85rem; font-weight:500;">
                                Extend / Reduce Users
                            </label>
                            <div class="input-group-icon mb-3">
                                <i class="fas fa-user-plus"></i>
                                <input type="number" name="extend_login" id="extendUsersInput" class="form-control"
                                    placeholder="e.g. +5 or -2"
                                    style="background:#1e293b; color:white; border:1px solid #334155; padding:10px 16px; border-radius:8px; font-size:0.9rem;">
                            </div>
                            <small style="color:#64748b; font-size:0.75rem; display:block;">
                                <i class="fas fa-info-circle me-1"></i>Use positive values to add, negative to remove
                            </small>
                        </div>
                    </div>

                    <!-- REMARK -->
                    <div class="mt-3">
                        <label class="form-label mb-2" style="color:#94a3b8; font-size:0.85rem; font-weight:500;">
                            Remark / Notes
                        </label>
                        <div class="input-group-icon">
                            <i class="fas fa-comment-alt" style="top:20px;"></i>
                            <textarea name="remark" rows="2" class="form-control"
                                placeholder="Add notes about this billing update..."
                                style="background:#1e293b; color:white; border:1px solid #334155; padding:5px 10px; border-radius:8px; resize:none; font-size:0.85rem;"></textarea>
                        </div>
                    </div>

                    <!-- SUBMIT BUTTON -->
                    <div class="mt-3">
                        <button type="submit" class="btn submit-btn px-5 py-2" {% if has_unbilled_history %}disabled{%
                            endif %}
                            style="background:#3b82f6; color:white; border:none; border-radius:8px; font-weight:600; font-size:0.95rem; {% if has_unbilled_history %}opacity:0.5; cursor:not-allowed;{% endif %}">
                            <i class="fas fa-save me-2"></i>Update Billing
                        </button>
                    </div>
                </fieldset>
            </form>

            <script>
                function toggleOperation(type) {
                    const tabValidity = document.getElementById('tab_validity');
                    const tabUsers = document.getElementById('tab_users');
                    const secValidity = document.getElementById('section_validity');
                    const secUsers = document.getElementById('section_users');
                    const operationType = document.getElementById('operation_type');

                    const selectPkg = document.getElementById('packageSelect');
                    const inputUsers = document.getElementById('extendUsersInput');

                    if (type === 'validity') {
                        // Activate validity tab
                        tabValidity.classList.add('active');
                        tabUsers.classList.remove('active');

                        secValidity.style.display = 'block';
                        secUsers.style.display = 'none';

                        operationType.value = 'validity';
                        inputUsers.value = '';
                    } else {
                        // Activate users tab
                        tabUsers.classList.add('active');
                        tabValidity.classList.remove('active');

                        secUsers.style.display = 'block';
                        secValidity.style.display = 'none';

                        operationType.value = 'users';
                        selectPkg.value = '';
                        handlePackageChange(selectPkg);
                    }
                }

                function handlePackageChange(select) {
                    const helper = document.getElementById('helperText');
                    if (select.value) {
                        const option = select.options[select.selectedIndex];
                        const days = option.getAttribute('data-days');
                        helper.innerHTML = `<i class="fas fa-check-circle me-1" style="color:#10b981;"></i>Selected package adds <b>${days} days</b>`;
                    } else {
                        helper.innerHTML = `<i class="fas fa-info-circle me-1"></i>Select a package to extend validity period`;
                    }
                }
            </script>
        </div>
    </div>

    <!-- BILLING HISTORY -->
    <div class="card" style="background:#0f172a; border:1px solid #1e293b; border-radius:10px;">
        <div class="card-body p-3">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <div class="p-2 rounded me-2" style="background:#1e293b;">
                        <i class="fas fa-history" style="color:#f59e0b; font-size:1rem;"></i>
                    </div>
                    <h5 class="mb-0" style="color:white; font-weight:600; font-size:1.1rem;">Billing History</h5>
                </div>
                <span class="badge" style="background:#1e293b; color:#94a3b8; padding:6px 12px; font-size:0.8rem;">
                    {{ history|length }} Record{{ history|length|pluralize }}
                </span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" style="color:white; font-size:0.85rem;">
                    <thead>
                        <tr style="border-bottom:2px solid #1e293b; background:#0a0f1e;">
                            <th
                                style="color:#94a3b8; font-weight:600; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.5px; padding:10px; background:#0a0f1e;">
                                <i class="fas fa-clock me-1"></i>Date
                            </th>
                            <th
                                style="color:#94a3b8; font-weight:600; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.5px; padding:10px; background:#0a0f1e;">
                                <i class="fas fa-calendar me-1"></i>Days
                            </th>
                            <th
                                style="color:#94a3b8; font-weight:600; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.5px; padding:10px; background:#0a0f1e;">
                                <i class="fas fa-users me-1"></i>Users
                            </th>
                            <th
                                style="color:#94a3b8; font-weight:600; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.5px; padding:10px; background:#0a0f1e;">
                                <i class="fas fa-exchange-alt me-1"></i>Change
                            </th>
                            <th
                                style="color:#94a3b8; font-weight:600; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.5px; padding:10px; background:#0a0f1e;">
                                <i class="fas fa-credit-card me-1"></i>Status
                            </th>
                            <th
                                style="color:#94a3b8; font-weight:600; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.5px; padding:10px; background:#0a0f1e;">
                                <i class="fas fa-comment me-1"></i>Remark
                            </th>
                        </tr>
                    </thead>
                    <tbody style="background:transparent;">
                        {% for h in history %}
                        <tr class="history-row" style="border-bottom:1px solid #1e293b; background:transparent;">
                            <td style="padding:12px; color:#e2e8f0; background:transparent;">
                                <div style="font-weight:500; font-size:0.85rem;">{{ h.created_at|date:"d M Y" }}</div>
                                <small style="color:#64748b; font-size:0.75rem;">{{ h.created_at|date:"H:i" }}</small>
                            </td>

                            <td style="padding:12px; background:transparent;">
                                <span class="badge"
                                    style="background:#1e293b; padding:6px 10px; border-radius:6px; font-size:0.8rem;
                                        color:{% if h.extended_days >= 0 %}#3b82f6{% else %}#dc2626{% endif %}; font-weight:600;">
                                    {% if h.extended_days >= 0 %}+{% endif %}{{ h.extended_days }}
                                </span>
                            </td>

                            <td style="padding:12px; background:transparent;">
                                <span class="badge"
                                    style="background:#1e293b; padding:6px 10px; border-radius:6px; font-size:0.8rem;
                                        color:{% if h.extended_login_limit >= 0 %}#8b5cf6{% else %}#dc2626{% endif %}; font-weight:600;">
                                    {% if h.extended_login_limit >= 0 %}+{% endif %}{{ h.extended_login_limit }}
                                </span>
                            </td>

                            <td
                                style="padding:12px; font-family:monospace; background:transparent; color:#e2e8f0; font-size:0.85rem;">
                                <span style="color:#94a3b8;">{{ h.old_login_limit }}</span>
                                <i class="fas fa-arrow-right mx-1" style="color:#64748b; font-size:0.7rem;"></i>
                                <span style="color:#3b82f6; font-weight:600;">{{ h.new_login_limit }}</span>
                            </td>

                            <td style="padding:12px; background:transparent;">
                                <button id="billingStatusBtn{{ h.id }}" onclick="toggleHistoryStatus({{ h.id }})"
                                    class="btn billing-status-btn"
                                    style="background:{% if h.bill_status %}#16a34a{% else %}#dc2626{% endif %};
                                                   color:white; border-radius:999px; padding:6px 14px; font-size:0.75rem; font-weight:600;">
                                    {% if h.bill_status %}
                                    <i class="fas fa-check-circle me-1"></i>Billed
                                    {% else %}
                                    <i class="fas fa-times-circle me-1"></i>Unbilled
                                    {% endif %}
                                </button>
                            </td>

                            <td
                                style="padding:12px; color:#94a3b8; max-width:200px; background:transparent; font-size:0.8rem;">
                                {{ h.remark|default:"â€”" }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr style="background:transparent;">
                            <td colspan="6" class="text-center"
                                style="padding:40px 20px; color:#64748b; background:transparent;">
                                <i class="fas fa-inbox fa-2x mb-2" style="opacity:0.3;"></i>
                                <div style="font-size:0.95rem; font-weight:500;">No billing history available</div>
                                <small style="color:#475569; font-size:0.8rem;">Updates will appear here</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>

</div>

<script>
    function toggleHistoryStatus(id) {
        if (!confirm("Are you sure you want to change the billing status?")) return;

        fetch(`/mobileapp/billing-history/toggle-status/${id}/`, {
            method: "POST",
            headers: { "X-CSRFToken": getCookie("csrftoken") }
        })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(data.error || "Failed to update status");
                    return;
                }

                const btn = document.getElementById("billingStatusBtn" + id);

                if (data.status) {
                    btn.style.background = "#16a34a";
                    btn.innerHTML = '<i class="fas fa-check-circle me-1"></i>Billed';
                } else {
                    btn.style.background = "#dc2626";
                    btn.innerHTML = '<i class="fas fa-times-circle me-1"></i>Unbilled';
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Server error occurred");
            });
    }

    function getCookie(name) {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [key, value] = cookie.split("=");
            if (key === name) return decodeURIComponent(value);
        }
        return null;
    }
</script>

{% endblock %}