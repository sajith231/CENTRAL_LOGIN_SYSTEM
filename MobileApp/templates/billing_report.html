{% extends "base.html" %}
{% block header_title %}<strong>Billing Report</strong>{% endblock %}
{% block content %}

<style>
  .billing-wrapper {
    background: #0f172a;
    border-radius: 10px;
    padding: 20px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .page-title {
    color: white;
    font-size: 24px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 14px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border: 1px solid #334155;
    border-radius: 10px;
    padding: 16px;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, #3b82f6, #1d4ed8);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .stat-card:hover::before { opacity: 1; }

  .stat-card:hover {
    border-color: #3b82f6;
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(59,130,246,0.2);
  }

  .stat-label {
    color: #9ca3af;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .stat-value {
    color: white;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .stat-subtext { color: #64748b; font-size: 11px; }

  .filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-input, .filter-select {
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #0f172a;
    color: white;
    font-size: 14px;
    min-width: 200px;
    transition: all 0.2s;
  }

  .filter-input:focus, .filter-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
  }

  .filter-input::placeholder { color: #64748b; }

  .table-container {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid #334155;
    background: #0a0f1e;
  }

  .billing-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  .billing-table thead {
    background: #1e293b;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .billing-table th {
    padding: 14px 12px;
    text-align: left;
    color: white;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
    border-bottom: 2px solid #3b82f6;
  }

  .billing-table tbody tr {
    background: #0f172a;
    border-bottom: 1px solid #1e293b;
    transition: background 0.2s;
  }

  .billing-table tbody tr:hover { background: #1a2332; }

  .billing-table td {
    padding: 13px 12px;
    color: #e2e8f0;
    vertical-align: middle;
  }

  .text-center { text-align: center; }
  .text-success { color: #22c55e; font-weight: 600; }
  .text-danger  { color: #ef4444; font-weight: 600; }

  .customer-name {
    color: white;
    font-weight: 600;
    display: block;
    font-size: 14px;
  }

  .customer-id {
    color: #9ca3af;
    font-size: 12px;
    display: block;
    margin-top: 2px;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
  }

  .badge-billed  { background: #16a34a; color: white; }
  .badge-pending { background: #f59e0b; color: white; }

  .badge-project {
    background: rgba(139,92,246,0.15);
    color: #a78bfa;
    border: 1px solid rgba(139,92,246,0.3);
    font-size: 11px;
    font-family: 'Courier New', monospace;
  }

  .invoice-badge {
    display: inline-block;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
    padding: 3px 9px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 11px;
    font-family: 'Courier New', monospace;
    margin-bottom: 4px;
  }

  .amount-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 13px;
  }

  .amount-pending { background: linear-gradient(135deg, #f59e0b, #d97706); }

  .change-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 12px;
  }

  .change-increase { background: rgba(34,197,94,0.1);   color: #22c55e; }
  .change-decrease { background: rgba(239,68,68,0.1);   color: #ef4444; }
  .change-neutral  { background: rgba(148,163,184,0.1); color: #94a3b8; }

  .no-data {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
  }

  .no-data-icon { font-size: 48px; margin-bottom: 16px; }

  /* â”€â”€ Pagination â”€â”€ */
  .pagination-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 16px;
    padding: 12px 4px;
  }

  .pagination-info {
    color: #9ca3af;
    font-size: 13px;
  }

  .pagination-info span {
    color: white;
    font-weight: 600;
  }

  .pagination-controls {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .pg-btn {
    background: #1e293b;
    border: 1px solid #334155;
    color: #cbd5e1;
    padding: 7px 14px;
    border-radius: 7px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .pg-btn:hover:not(:disabled) {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
  }

  .pg-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .pg-btn.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
  }

  .pg-pages {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  .rows-select {
    padding: 7px 12px;
    border-radius: 7px;
    border: 1px solid #334155;
    background: #1e293b;
    color: white;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .rows-select:focus {
    outline: none;
    border-color: #3b82f6;
  }

  .rows-label {
    color: #9ca3af;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
</style>

<div class="billing-wrapper">

  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">
      <i class="fa-solid fa-receipt"></i>
      Billing History
    </h1>
  </div>

  <!-- Stats -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-label"><i class="fa-solid fa-list"></i> Total Records</div>
      <div class="stat-value">{{ total_records }}</div>
      <div class="stat-subtext">All billing entries</div>
    </div>

    <div class="stat-card">
      <div class="stat-label"><i class="fa-solid fa-circle-check"></i> Billed</div>
      <div class="stat-value">{{ billed_records }}</div>
      <div class="stat-subtext">Invoice paid</div>
    </div>

    <div class="stat-card">
      <div class="stat-label"><i class="fa-solid fa-clock"></i> Pending</div>
      <div class="stat-value">{{ pending_records }}</div>
      <div class="stat-subtext">Awaiting payment</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <input
      type="text"
      id="searchInput"
      class="filter-input"
      placeholder="ðŸ” Search customer, client ID, invoice, project..."
      oninput="applyFilters()"
    >

    <select id="billFilter" class="filter-select" onchange="applyFilters()">
      <option value="">All Billing Status</option>
      <option value="billed">Billed</option>
      <option value="pending">Pending</option>
    </select>

    <!-- Rows per page -->
    <label class="rows-label">
      <i class="fa-solid fa-table-list"></i> Rows:
      <select id="rowsPerPage" class="rows-select" onchange="applyFilters()">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>
    </label>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table class="billing-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Date & Time</th>
          <th>Customer</th>
          <th>Project</th>
          <th>Invoice Details</th>
          <th>User Limit Change</th>
          <th>Days Extended</th>
          <th>Old Expiry</th>
          <th>New Expiry</th>
          <th class="text-center">Status</th>
          <th>Remark</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        {% for h in billing_history %}
        <tr class="data-row"
            data-bill="{% if h.bill_status %}billed{% else %}pending{% endif %}">

          <td style="color:#64748b; font-weight:600; white-space:nowrap;" class="row-num">{{ forloop.counter }}</td>

          <td style="white-space:nowrap;">
            <strong style="color:white; font-size:13px; display:block;">{{ h.created_at|date:"d M Y" }}</strong>
            <small style="color:#64748b;">{{ h.created_at|date:"h:i A" }}</small>
          </td>

          <td>
            <span class="customer-name">{{ h.control.customer_name }}</span>
            <span class="customer-id">{{ h.control.client_id }}</span>
          </td>

          <td>
            <span class="badge badge-project">
              <i class="fa-solid fa-mobile-screen-button"></i>
              {{ h.control.project.project_name|default:"â€”" }}
            </span>
          </td>

          <td style="white-space:nowrap;">
            {% if h.invoice_number %}
              <div>
                <span class="invoice-badge">
                  <i class="fa-solid fa-file-invoice"></i> {{ h.invoice_number }}
                </span>
              </div>
            {% endif %}
            {% if h.invoice_amount %}
              <span class="amount-badge {% if not h.bill_status %}amount-pending{% endif %}">
                <i class="fa-solid fa-indian-rupee-sign"></i>
                {{ h.invoice_amount|floatformat:2 }}
              </span>
            {% else %}
              <span style="color:#64748b;">No invoice</span>
            {% endif %}
          </td>

          <td>
            {% if h.old_login_limit != h.new_login_limit %}
              {% if h.new_login_limit > h.old_login_limit %}
                <span class="change-indicator change-increase">
                  {{ h.old_login_limit }} â†’ {{ h.new_login_limit }}
                  <i class="fa-solid fa-arrow-up"></i>
                </span>
              {% else %}
                <span class="change-indicator change-decrease">
                  {{ h.old_login_limit }} â†’ {{ h.new_login_limit }}
                  <i class="fa-solid fa-arrow-down"></i>
                </span>
              {% endif %}
            {% else %}
              <span class="change-indicator change-neutral">
                {{ h.old_login_limit }} (No change)
              </span>
            {% endif %}
          </td>

          <td style="white-space:nowrap;">
            {% if h.extended_days > 0 %}
              <span class="text-success">
                <i class="fa-solid fa-plus"></i> {{ h.extended_days }} days
              </span>
            {% elif h.extended_days < 0 %}
              <span class="text-danger">
                <i class="fa-solid fa-minus"></i> {{ h.extended_days|slice:"1:" }} days
              </span>
            {% else %}
              <span style="color:#64748b;">â€”</span>
            {% endif %}
          </td>

          <td style="white-space:nowrap;">
            {% if h.old_expiry_date %}
              <strong style="color:#cbd5e1; font-size:13px;">{{ h.old_expiry_date|date:"d M Y" }}</strong>
            {% else %}
              <span style="color:#64748b;">â€”</span>
            {% endif %}
          </td>

          <td style="white-space:nowrap;">
            {% if h.new_expiry_date %}
              <strong style="color:#cbd5e1; font-size:13px;">{{ h.new_expiry_date|date:"d M Y" }}</strong>
            {% else %}
              <span style="color:#64748b;">â€”</span>
            {% endif %}
          </td>

          <td class="text-center">
            {% if h.bill_status %}
              <span class="badge badge-billed">
                <i class="fa-solid fa-check"></i> Billed
              </span>
            {% else %}
              <span class="badge badge-pending">
                <i class="fa-solid fa-clock"></i> Pending
              </span>
            {% endif %}
          </td>

          <td style="font-style:italic; color:#9ca3af; max-width:160px;">
            {{ h.remark|default:"â€”" }}
          </td>
        </tr>

        {% empty %}
        <tr>
          <td colspan="11" class="no-data">
            <div class="no-data-icon">ðŸ“­</div>
            <div style="font-size:18px; font-weight:600; margin-bottom:10px; color:white;">No billing records found</div>
            <div style="color:#64748b;">Billing entries will appear here once added.</div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Bar -->
  <div class="pagination-bar">
    <div class="pagination-info" id="paginationInfo">
      Showing <span id="showingFrom">â€“</span> to <span id="showingTo">â€“</span> of <span id="totalVisible">â€“</span> records
    </div>

    <div class="pagination-controls">
      <button class="pg-btn" id="btnFirst" onclick="goToPage(1)" title="First">
        <i class="fa-solid fa-angles-left"></i>
      </button>
      <button class="pg-btn" id="btnPrev" onclick="goToPage(currentPage - 1)" title="Previous">
        <i class="fa-solid fa-angle-left"></i> Prev
      </button>

      <div class="pg-pages" id="pageNumbers"></div>

      <button class="pg-btn" id="btnNext" onclick="goToPage(currentPage + 1)" title="Next">
        Next <i class="fa-solid fa-angle-right"></i>
      </button>
      <button class="pg-btn" id="btnLast" onclick="goToPage(totalPages)" title="Last">
        <i class="fa-solid fa-angles-right"></i>
      </button>
    </div>
  </div>

</div>

<script>
  let currentPage  = 1;
  let totalPages   = 1;
  let filteredRows = [];

  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const bill   = document.getElementById('billFilter').value;

    filteredRows = Array.from(document.querySelectorAll('.data-row')).filter(row => {
      const matchSearch = !search || row.textContent.toLowerCase().includes(search);
      const matchBill   = !bill   || row.getAttribute('data-bill') === bill;
      return matchSearch && matchBill;
    });

    currentPage = 1;
    renderPage();
  }

  function renderPage() {
    const rowsVal = document.getElementById('rowsPerPage').value;
    const perPage = rowsVal === 'all' ? filteredRows.length || 1 : parseInt(rowsVal);

    totalPages = Math.max(1, Math.ceil(filteredRows.length / perPage));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * perPage;
    const end   = Math.min(start + perPage, filteredRows.length);

    // Hide all rows first
    document.querySelectorAll('.data-row').forEach(r => r.style.display = 'none');

    // Show only current page rows and update serial number
    filteredRows.forEach((row, idx) => {
      if (idx >= start && idx < end) {
        row.style.display = '';
        const numCell = row.querySelector('.row-num');
        if (numCell) numCell.textContent = idx + 1;
      }
    });

    // Update info text
    document.getElementById('showingFrom').textContent  = filteredRows.length ? start + 1 : 0;
    document.getElementById('showingTo').textContent    = end;
    document.getElementById('totalVisible').textContent = filteredRows.length;

    // Prev / Next / First / Last buttons
    document.getElementById('btnFirst').disabled = currentPage === 1;
    document.getElementById('btnPrev').disabled  = currentPage === 1;
    document.getElementById('btnNext').disabled  = currentPage === totalPages;
    document.getElementById('btnLast').disabled  = currentPage === totalPages;

    // Page number buttons (show up to 5 around current)
    const pgContainer = document.getElementById('pageNumbers');
    pgContainer.innerHTML = '';

    if (rowsVal === 'all') {
      pgContainer.innerHTML = '';
      return;
    }

    let startPg = Math.max(1, currentPage - 2);
    let endPg   = Math.min(totalPages, startPg + 4);
    if (endPg - startPg < 4) startPg = Math.max(1, endPg - 4);

    for (let p = startPg; p <= endPg; p++) {
      const btn = document.createElement('button');
      btn.className = 'pg-btn' + (p === currentPage ? ' active' : '');
      btn.textContent = p;
      btn.onclick = () => goToPage(p);
      pgContainer.appendChild(btn);
    }
  }

  function goToPage(page) {
    const rowsVal  = document.getElementById('rowsPerPage').value;
    const perPage  = rowsVal === 'all' ? filteredRows.length || 1 : parseInt(rowsVal);
    totalPages = Math.max(1, Math.ceil(filteredRows.length / perPage));

    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPage();
  }

  // Boot
  document.addEventListener('DOMContentLoaded', () => {
    filteredRows = Array.from(document.querySelectorAll('.data-row'));
    renderPage();
  });
</script>

{% endblock %}