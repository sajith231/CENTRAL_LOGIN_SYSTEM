{% extends "base.html" %}
{% load static %}

{% block active_mobile_control %}active{% endblock %}
{% block header_title %}<strong>Mobile Control</strong>{% endblock %}

{% block content %}
<div class="card">
    <!-- Header Section -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; font-size:20px;">Add Licensing</h2>

        <!-- Add Control Button -->
        <a href="{% url 'MobileApp:add_mobile_control' %}" class="btn"
           style="background:#16a34a; color:white; padding:8px 16px; border-radius:6px;">
            <i class="fa-solid fa-sliders"></i> Add Licensing
        </a>
    </div>

    <!-- Filter Dropdown -->
    <div style="margin-bottom:15px;">
        <select id="projectFilter"
                style="padding:8px; border-radius:6px; border:1px solid #334155; background:#0f172a; color:white;">
            <option value="">All Projects</option>

            {% for c in controls %}
                <option value="{{ c.project.project_name }}">{{ c.project.project_name }}</option>
            {% endfor %}
        </select>
    </div>

    <script>
        document.getElementById("projectFilter").addEventListener("change", function () {
            let selected = this.value.toLowerCase();
            let rows = document.querySelectorAll("table tbody tr");

            rows.forEach(row => {
                let project = row.querySelector("td:nth-child(3)").innerText.toLowerCase();
                row.style.display = (selected === "" || project === selected) ? "" : "none";
            });
        });
    </script>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div style="background:#1e293b; padding:12px; border-radius:10px; margin-bottom:10px;">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Table Section -->
    {% if controls %}
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#1e293b;">
                    <th style="padding:12px; text-align:left;">No</th>
                    <th style="padding:12px; text-align:left;">Created</th>
                    <th style="padding:12px; text-align:left;">Project</th>
                    <th style="padding:12px; text-align:left;">Store</th>
                    <th style="padding:12px; text-align:left;">Shop</th>
                    <th style="padding:12px; text-align:left;">Client ID</th>
                    <th style="padding:12px; text-align:left;">Package</th>
                    <th style="padding:12px; text-align:left;">Modules</th>
                    <th style="padding:12px; text-align:center;">Number of users</th>
                    <th style="padding:12px;">License Key</th>
                    <th style="padding:12px; text-align:center;">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for c in controls %}
                <tr style="border-bottom:1px solid #1e293b; background:#0f172a;">
                    <td style="padding:12px;">{{ forloop.counter }}</td>
                    <td style="padding:12px;">{{ c.created_date|date:"Y-m-d" }}</td>
                    <td style="padding:12px;"><strong>{{ c.project.project_name }}</strong></td>
                    <td style="padding:12px;">{{ c.store.name }}</td>
                    <td style="padding:12px;">{{ c.customer_name }}</td>
                    <td style="padding:12px;">
                        <span style="background:#16a34a33; padding:4px 8px; border-radius:6px; font-weight:600; color:#16a34a;">
                            {{ c.client_id }}
                        </span>
                    </td>
                    <td style="padding:12px;">
    {% if c.package %}
        <span style="background:#1e3a8a; padding:4px 8px; border-radius:6px; color:#93c5fd;">
            {{ c.package.package_name }}
        </span>
    {% else %}
        <span style="color:#9ca3af;">-</span>
    {% endif %}
</td>
<td style="padding:12px;">
    {% if c.package %}
        {% for m in c.package.modules.all %}
            <div style="margin-bottom:4px;">
                <span style="background:#0f172a; padding:4px 8px; border-radius:6px; color:#fbbf24; font-size:12px;">
                    {{ m.module_name }}
                </span>
                <span style="background:#1e293b; padding:4px 8px; border-radius:6px; color:#38bdf8; font-size:12px;">
                    {{ m.module_code }}
                </span>
            </div>
        {% endfor %}
    {% else %}
        <span style="color:#9ca3af;">No Modules</span>
    {% endif %}
</td>

                    
                    <td style="padding:12px; text-align:center;">{{ c.login_limit }}</td>
                    <td style="padding:12px;">
    <span id="license_{{ c.id }}">{{ c.license_key }}</span>
    <button onclick="copyLicense('{{ c.id }}')" class="btn btn-sm btn-secondary">Copy</button>
</td>

                    <td style="padding:12px; text-align:center;">
                        <!-- Edit Button -->
                        <a href="{% url 'MobileApp:edit_mobile_control' c.id %}"
                           class="btn" style="background:#2563eb; color:white; padding:6px 12px; border-radius:6px;">
                            <i class="fa-solid fa-pen-to-square"></i> Edit
                        </a>

                        <!-- Delete Button -->
                        <button class="btn" style="background:#b91c1c; color:white; padding:6px 12px; border-radius:6px;"
                                data-bs-toggle="modal" data-bs-target="#deleteModal{{ c.id }}">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Summary -->
    <p style="margin-top:16px; color:#9ca3af;">
        Total Controls: {{ controls.count }}
    </p>

    {% else %}
    <!-- No Data Section -->
    <div style="padding:40px; text-align:center;">
        <i class="fa-solid fa-circle-info" style="font-size:40px; margin-bottom:10px; color:#9ca3af;"></i>
        <h3>No controls found</h3>
        <p style="color:#9ca3af;">Add one via the “Control” button above.</p>
    </div>
    {% endif %}
</div>

<!-- Delete Modals -->
{% for c in controls %}
<div class="modal fade" id="deleteModal{{ c.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#1e293b; color:white;">
            <div class="modal-header" style="border-bottom:1px solid #334155;">
                <h5 class="modal-title">Confirm Delete</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete:</p>
                <h4 class="text-center" style="color:#f87171;">
                    {{ c.customer_name }} — {{ c.project.project_name }}
                </h4>
            </div>
            <div class="modal-footer" style="border-top:1px solid #334155;">
                <button class="btn" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'MobileApp:delete_mobile_control' c.id %}"
                   class="btn" style="background:#b91c1c; color:white;">
                    Yes, Delete
                </a>
            </div>
        </div>
    </div>
</div>
<script>
function copyLicense(id) {
    var text = document.getElementById("license_" + id).innerText;
    navigator.clipboard.writeText(text);
    alert("Copied: " + text);
}
</script>

{% endfor %}
{% endblock %}
