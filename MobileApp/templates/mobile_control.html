{% extends "base.html" %}
{% load static %}

{% block active_mobile_control %}active{% endblock %}
{% block header_title %}<strong>Mobile Control</strong>{% endblock %}

{% block content %}
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; font-size:20px;">Add Licensing</h2>
        <a href="{% url 'MobileApp:add_mobile_control' %}" class="btn"
           style="background:#16a34a; color:white; padding:8px 16px; border-radius:6px;">
            <i class="fa-solid fa-sliders"></i> Add Licensing
        </a>
    </div>

    <div style="margin-bottom:15px;">
        <select id="projectFilter"
            style="padding:8px; border-radius:6px; border:1px solid #334155; background:#0f172a; color:white;">
            <option value="">All Projects</option>
            {% for c in controls %}
            <option value="{{ c.project.project_name }}">{{ c.project.project_name }}</option>
            {% endfor %}
        </select>
    </div>

    <script>
        document.getElementById("projectFilter").addEventListener("change", function () {
            let selected = this.value.toLowerCase();
            let rows = document.querySelectorAll("table tbody tr");

            rows.forEach(row => {
                let project = row.querySelector("td:nth-child(3)").innerText.toLowerCase();
                row.style.display = (selected === "" || project === selected) ? "" : "none";
            });
        });
    </script>

    {% if messages %}
        {% for message in messages %}
        <div style="background:#1e293b; padding:12px; border-radius:10px; margin-bottom:10px;">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    {% if controls %}
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#1e293b;">
                    <th style="padding:12px;">No</th>
                    <th style="padding:12px;">Created</th>
                    <th style="padding:12px;">Project</th>
                    <th style="padding:12px;">Store</th>
                    <th style="padding:12px;">Shop</th>
                    <th style="padding:12px;">Client ID</th>
                    <th style="padding:12px;">Package</th>
                    <th style="padding:12px;text-align:center;">Remaining Days</th>
                    <th style="padding:12px;text-align:center;">Reg.Dev</th>
                    <th style="padding:12px;text-align:center;">Bal.Lic</th>
                    <th style="padding:12px;text-align:center;">Device List</th>
                    <th style="padding:12px;text-align:center;">Number of users</th>
                    <th style="padding:12px;">License Key</th>
                    <th style="padding:12px;text-align:center;">Status</th>
                    <th style="padding:12px;text-align:center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for c in controls %}
                <tr style="background:#0f172a; border-bottom:1px solid #1e293b;">
                    <td style="padding:12px;">{{ forloop.counter }}</td>
                    <td style="padding:12px;">{{ c.created_date|date:"Y-m-d" }}</td>
                    <td style="padding:12px;"><strong>{{ c.project.project_name }}</strong></td>
                    <td style="padding:12px;">{{ c.store.name }}</td>
                    <td style="padding:12px;">{{ c.customer_name }}</td>
                    <td style="padding:12px;">
                        <span style="background:#16a34a33; padding:4px 8px; border-radius:6px; color:#16a34a;">
                            {{ c.client_id }}
                        </span>
                    </td>
                    <td style="padding:12px;">
                        {% if c.package %}
                        <span style="background:#1e3a8a; padding:4px 8px; border-radius:6px; color:#93c5fd;white-space: nowrap;">
                            {{ c.package.package_name }}
                        </span>
                        {% else %}
                        <span style="color:#9ca3af;">-</span>
                        {% endif %}
                    </td>

                    <td style="padding:12px;text-align:center;">
                        {% if c.remaining_days is None %}
                            <span style="color:#9ca3af;">Unlimited</span>
                        {% elif c.is_expired %}
                            <span style="color:#dc2626; font-weight:bold;">Expired</span>
                        {% else %}
                            <div>
                                <span id="countdown_{{ c.id }}" 
                                      data-expiry="{{ c.expiry_date|date:'c' }}"
                                      style="{% if c.remaining_days <= 3 %}color:#dc2626; font-weight:bold;{% else %}color:#16a34a;{% endif %} font-size:14px;">
                                    {{ c.remaining_days }} day{{ c.remaining_days|pluralize }}
                                </span>
                                {% if c.expiry_date %}
                                <div style="font-size:11px; color:#6b7280; margin-top:4px;">
                                    <small>Expires: {{ c.expiry_date|date:"M d, Y" }}</small>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </td>

                    <td style="padding:12px;text-align:center;">
                        {{ c.registered_count }}
                    </td>
                    <td style="padding:12px;text-align:center;">
                        {{ c.balance_count }}
                    </td>


                    <td style="padding:12px;text-align:center;">
                        <button class="btn btn-sm"
                            style="background:#0ea5e9; color:white; padding:6px 12px; border-radius:6px;"
                            data-bs-toggle="modal" data-bs-target="#deviceModal{{ c.id }}"
                            onclick="loadDeviceList('{{ c.project.api_endpoint }}', '{{ c.license_key }}', {{ forloop.counter }})">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </td>

                    <td style="padding:12px;text-align:center;">{{ c.login_limit }}</td>

                    <td style="padding:12px;">
                        <span id="license_{{ c.id }}">{{ c.license_key }}</span>
                        <button onclick="copyLicense('{{ c.id }}')" class="btn btn-sm btn-secondary">Copy</button>
                    </td>

                    <td style="padding:12px;text-align:center;">
                        <button id="statusBtn_{{ c.id }}" 
                                onclick="toggleStatus({{ c.id }})"
                                class="btn btn-sm"
                                style="{% if c.status %}background:#16a34a; color:white;{% else %}background:#dc2626; color:white;{% endif %} padding:6px 12px; border-radius:6px; min-width:80px;">
                            {% if c.status %}Active{% else %}Inactive{% endif %}
                        </button>
                    </td>

                    <td style="padding:12px;text-align:center; display:flex; gap:4px;">
                        <a href="{% url 'MobileApp:edit_mobile_control' c.id %}" class="btn"
                           style="background:#2563eb; color:white;">Edit</a>
                        <button class="btn"
                           style="background:#b91c1c; color:white;"
                           data-bs-toggle="modal" data-bs-target="#deleteModal{{ c.id }}">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <p style="margin-top:16px; color:#9ca3af;">Total Controls: {{ controls.count }}</p>

    {% else %}
    <div style="padding:40px; text-align:center; color:#9ca3af;">
        <h3>No controls found</h3>
    </div>
    {% endif %}
</div>

{% for c in controls %}
<!-- DEVICE LIST POPUP -->
<div class="modal fade" id="deviceModal{{ c.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background:#1e293b; color:white;">
            <div class="modal-header" style="border-bottom:1px solid #334155;">
                <h5 class="modal-title">
                    <i class="fa-solid fa-mobile-screen"></i>
                    Devices â€” {{ c.customer_name }}
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deviceList{{ forloop.counter }}"
                 style="max-height:400px; overflow-y:auto; background:#0f172a; padding:12px; border-radius:8px;">
                <em>Loading...</em>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Copy Script -->
<script>
function copyLicense(id) {
    var text = document.getElementById("license_" + id).innerText;
    navigator.clipboard.writeText(text);
    alert("Copied: " + text);
}

// Toggle Status Function
async function toggleStatus(controlId) {
    if (!confirm("Are you sure you want to change the status?")) return;
    
    try {
        const response = await fetch(`/mobileapp/mobile_control/toggle-status/${controlId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const btn = document.getElementById(`statusBtn_${controlId}`);
            if (data.status) {
                btn.innerHTML = 'Active';
                btn.style.background = '#16a34a';
            } else {
                btn.innerHTML = 'Inactive';
                btn.style.background = '#dc2626';
            }
        } else {
            alert(data.error || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update status');
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- DEVICE ACTION SCRIPTS -->
<script>
async function loadDeviceList(endpoint, license, index) {
    const url = `/mobileapp/api/project/${endpoint}/`;
    const container = document.getElementById("deviceList" + index);

    const res = await fetch(url);
    const data = await res.json();
    const customer = data.customers.find(item => item.license_key === license);
    const devices = customer?.registered_devices || [];

    if (devices.length === 0) {
        container.innerHTML = `<p style="color:#9ca3af;">No devices registered.</p>`;
        return;
    }

    let html = `
    <table style="width:100%; font-size:13px; color:white;">
    <tr style="border-bottom:1px solid #334155;">
      <th>Device ID</th><th>IP</th><th>Logged at</th><th style="text-align:center;"></th>
    </tr>`;

    devices.forEach(device => {
        html += `
        <tr style="border-bottom:1px solid #334155;">
          <td>${device.device_id}</td>
          <td>${device.ip_address || '-'}</td>
          <td>${new Date(device.logged_in_at).toLocaleString()}</td>
          <td style="text-align:center;">
            <button onclick="removeDevice('${endpoint}','${license}','${device.device_id}', ${index})"
                  class="btn btn-sm"
                  style="background:#b91c1c; color:white;">Remove</button>
          </td>
        </tr>`;
    });

    html += `</table>`;
    container.innerHTML = html;
}

async function removeDevice(endpoint, license, device_id, index) {
    if (!confirm("Are you sure?")) return;
    const res = await fetch(`/mobileapp/api/project/${endpoint}/logout/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ license_key: license, device_id })
    });

    const data = await res.json();
    alert(data.message || data.error);
    loadDeviceList(endpoint, license, index);
}

// Real-time countdown timer
document.addEventListener('DOMContentLoaded', function() {
    const countdownElements = document.querySelectorAll('[id^="countdown_"]');
    
    countdownElements.forEach(function(countdownElement) {
        const expiryDateStr = countdownElement.getAttribute('data-expiry');
        if (!expiryDateStr) return;
        
        // Parse ISO date string (format: YYYY-MM-DDTHH:MM:SS+00:00)
        let expiryDate;
        if (expiryDateStr.includes('T')) {
            expiryDate = new Date(expiryDateStr).getTime();
        } else {
            // Fallback for older format
            expiryDate = new Date(expiryDateStr.replace(' ', 'T') + 'Z').getTime();
        }
        
        if (isNaN(expiryDate)) {
            console.error('Invalid expiry date:', expiryDateStr);
            return;
        }
        
        function updateCountdown() {
            const now = new Date().getTime();
            const distance = expiryDate - now;
            
            if (distance < 0) {
                countdownElement.innerHTML = '<span style="color:#dc2626; font-weight:bold;">Expired</span>';
                countdownElement.style.color = '#dc2626';
                return;
            }
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            let color = '#16a34a';
            if (days <= 3) color = '#dc2626';
            
            countdownElement.style.color = color;
            countdownElement.style.fontWeight = days <= 3 ? 'bold' : 'normal';
            countdownElement.style.display = 'inline-block';
            
            // Format countdown display
            if (days > 0) {
                countdownElement.innerHTML = `<strong>${days}</strong> day${days !== 1 ? 's' : ''}`;
            } else if (hours > 0) {
                countdownElement.innerHTML = `<strong>${hours}h</strong> ${minutes}m`;
            } else if (minutes > 0) {
                countdownElement.innerHTML = `<strong>${minutes}m</strong> ${seconds}s`;
            } else {
                countdownElement.innerHTML = `<strong>${seconds}s</strong>`;
            }
        }
        
        updateCountdown();
        setInterval(updateCountdown, 1000); // Update every second
    });
});
</script>

{% endblock %}
